name: arm64 release

on:
  push:
    tags:
    - 'v*'

jobs:
  arm64:
    name: build-arm64-deb
    runs-on: ubuntu-22.04
    
    steps:
    - name: Checkout
      uses: actions/checkout@v2

    - name: Set up QEMU
      uses: docker/setup-qemu-action@v2
      with:
        platforms: arm64

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v2

    - name: Build ARM64 Debian package
      run: |
        # Extract version from tag
        VERSION=$(echo "${{ github.ref }}" | sed 's/refs\/tags\///g' | sed 's/^v//')
        echo "Building version: $VERSION for PocketBeagle 2 (ARM64)"
        
        # Create a Dockerfile for native ARM64 build
        cat > Dockerfile << 'EOF'
        FROM ubuntu:22.04

        # Set up environment
        ENV DEBIAN_FRONTEND=noninteractive
        
        # Update and install dependencies
        RUN apt-get update && apt-get install -y \
            build-essential \
            cmake \
            pkg-config \
            libnm-dev \
            libglib2.0-dev \
            debhelper \
            dh-make \
            git \
            && rm -rf /var/lib/apt/lists/*

        WORKDIR /build
        COPY . .

        RUN mkdir build && cd build && \
            cmake .. \
              -DCMAKE_C_FLAGS="-mcpu=cortex-a53 -mtune=cortex-a53 -O2 -pipe" \
              -DCMAKE_CXX_FLAGS="-mcpu=cortex-a53 -mtune=cortex-a53 -O2 -pipe" \
              -DARCHITECTURE="arm64" \
              -DGIT_VERSION="$VERSION" && \
            make -j$(nproc) && \
            # Generate DEB package with proper architecture
            cpack -G DEB -D CPACK_DEBIAN_PACKAGE_ARCHITECTURE=arm64
        EOF

        # Build for ARM64 using buildx
        docker buildx build \
          --platform linux/arm64 \
          --tag arm64-builder \
          --load \
          .
        
        # Create container and extract package
        docker create --name builder arm64-builder
        docker cp builder:/build/build/ ./
        docker rm builder
        
        # Find the generated .deb file
        ARM64_FILENAME=$(ls build/*.deb | head -1)
        if [ -z "$ARM64_FILENAME" ]; then
          echo "Error: No .deb file found!"
          ls -la build/
          exit 1
        fi
        
        echo "Generated package: $ARM64_FILENAME"
        echo "arm64_filename=$(basename $ARM64_FILENAME)" >> $GITHUB_ENV
        echo "version=$VERSION" >> $GITHUB_ENV

    - name: Verify Debian package
      run: |
        echo "Verifying Debian package structure..."
        dpkg-deb -I ./build/${{ env.arm64_filename }}
        echo "Package contents:"
        dpkg-deb -c ./build/${{ env.arm64_filename }}

    - name: Create Release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ github.ref_name }}
        release_name: Release ${{ github.ref_name }}
        draft: false
        prerelease: false

    - name: Upload Release Asset
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./build/${{ env.arm64_filename }}
        asset_name: ${{ env.arm64_filename }}
        asset_content_type: application/vnd.debian.binary-package